name: Release from master

on:
  push:
    branches:
      - master

env:
  GWA_API_HOST: api.gov.bc.ca
  GWA_CLIENT_ID: gwa-cli
  GWA_VERSION: v2

jobs:
  release-tag:
    name: create release tag
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - id: release
        uses: rymndhng/release-on-push-action@v0.28.0
        with:
          bump_version_scheme: minor
    outputs:
      version_number: ${{ steps.release.outputs.tag_name }}

  goreleaser:
    runs-on: ubuntu-latest
    needs: release-tag
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: git fetch --force --tags
      - name: Make envfile
        uses: SpicyPizza/create-envfile@v2.0
        with:
          envkey_GWA_API_HOST: ${{ env.GWA_API_HOST }}
          envkey_GWA_CLIENT_ID: ${{ env.GWA_CLIENT_ID }}
          envkey_GWA_VERSION: ${{ needs.release-tag.outputs.version_number }}
      - uses: extractions/setup-just@v1
      - uses: actions/setup-go@v4
        with:
          go-version: stable
      # - name: test
      #   run: just test
      # - name: generate commands documentation
      #   run: just docs
      # - name: Commit docs
      #   uses: EndBug/add-and-commit@v9
      #   with:
      #     default_author: github_actions
      #     message: 'Generate new docs'
      #     add: 'docs/*.md'
      - uses: goreleaser/goreleaser-action@v4
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GWA_API_HOST: ${{ env.GWA_API_HOST }}
          GWA_CLIENT_ID: ${{ env.GWA_CLIENT_ID }}
          GWA_VERSION: ${{ needs.release-tag.outputs.version_number }}
